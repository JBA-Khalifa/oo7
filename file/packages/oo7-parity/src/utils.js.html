<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/oo7-parity/src/utils.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src">oo7-parity/src</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-capitalizeFirstLetter">capitalizeFirstLetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanup">cleanup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineValue">combineValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defDenom">defDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-denominationMultiplier">denominationMultiplier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBalance">formatBalance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBlockNumber">formatBlockNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatToExponential">formatToExponential</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValue">formatValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValueNoDenom">formatValueNoDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretQuantity">interpretQuantity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretRender">interpretRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAddressValid">isAddressValid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNullData">isNullData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeSigningPrefix">removeSigningPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha3">sha3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-singleton">singleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitSignature">splitSignature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitValue">splitValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toChecksumAddress">toChecksumAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-asciiToHex">asciiToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bytesToHex">bytesToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-denominations">denominations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hexToAscii">hexToAscii</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src-abis">oo7-parity/src/abis</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-abiPolyfill">abiPolyfill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RegistryExtras">RegistryExtras</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-lib">oo7/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/bond.js~Bond.html">Bond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/bondCache.js~BondCache.html">BondCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/bondProxy.js~BondProxy.html">BondProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/notReadyBond.js~NotReadyBond.html">NotReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/reactiveBond.js~ReactiveBond.html">ReactiveBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/reactivePromise.js~ReactivePromise.html">ReactivePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/readyBond.js~ReadyBond.html">ReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/timeBond.js~TimeBond.html">TimeBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/lib/transformBond.js~TransformBond.html">TransformBond</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/oo7-parity/src/utils.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// (C) Copyright 2016-2017 Parity Technologies (UK) Ltd.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//         http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/* global parity */
const BigNumber = require(&apos;bignumber.js&apos;);
const oo7 = require(&apos;oo7&apos;);
const ParityApi = require(&apos;@parity/api&apos;);

const asciiToHex = ParityApi.util.asciiToHex;
const bytesToHex = ParityApi.util.bytesToHex;
const hexToAscii = ParityApi.util.hexToAscii;
const isAddressValid = h =&gt; oo7.Bond.instanceOf(h) ? h.map(ParityApi.util.isAddressValid) : ParityApi.util.isAddressValid(h);
const toChecksumAddress = h =&gt; oo7.Bond.instanceOf(h) ? h.map(ParityApi.util.toChecksumAddress) : ParityApi.util.toChecksumAddress(h);
const sha3 = h =&gt; oo7.Bond.instanceOf(h) ? h.map(ParityApi.util.sha3) : ParityApi.util.sha3(h);

const denominations = [ &apos;wei&apos;, &apos;Kwei&apos;, &apos;Mwei&apos;, &apos;Gwei&apos;, &apos;szabo&apos;, &apos;finney&apos;, &apos;ether&apos;, &apos;grand&apos;, &apos;Mether&apos;, &apos;Gether&apos;, &apos;Tether&apos;, &apos;Pether&apos;, &apos;Eether&apos;, &apos;Zether&apos;, &apos;Yether&apos;, &apos;Nether&apos;, &apos;Dether&apos;, &apos;Vether&apos;, &apos;Uether&apos; ];

/// /
// Parity Utilities

// TODO: move to parity.js, repackage or repot.

function capitalizeFirstLetter (s) {
	return s.charAt(0).toUpperCase() + s.slice(1);
}

function singleton (f) {
	var instance = null;
	return function () {
		if (instance === null) { instance = f(); }
		return instance;
	};
}

function denominationMultiplier (s) {
	let i = denominations.indexOf(s);
	if (i &lt; 0) { throw new Error(&apos;Invalid denomination&apos;); }
	return (new BigNumber(1000)).pow(i);
}

function interpretRender (s, defaultDenom = 6) {
	try {
		let m = s.toLowerCase().match(/([0-9,]+)(\.([0-9]*))? *([a-zA-Z]+)?/);
		let di = m[4] ? denominations.indexOf(m[4]) : defaultDenom;
		if (di === -1) {
			return null;
		}
		let n = (m[1].replace(&apos;,&apos;, &apos;&apos;).replace(/^0*/, &apos;&apos;)) || &apos;0&apos;;
		let d = (m[3] || &apos;&apos;).replace(/0*$/, &apos;&apos;);
		return { denom: di, units: n, decimals: d, origNum: m[1] + (m[2] || &apos;&apos;), origDenom: m[4] || &apos;&apos; };
	} catch (e) {
		return null;
	}
}

function combineValue (v) {
	let d = (new BigNumber(1000)).pow(v.denom);
	let n = v.units;
	if (v.decimals) {
		n += v.decimals;
		d = d.div((new BigNumber(10)).pow(v.decimals.length));
	}
	return new BigNumber(n).mul(d);
}

function defDenom (v, d) {
	if (v.denom === null) {
		v.denom = d;
	}
	return v;
}

function formatValue (n) {
	return `${formatValueNoDenom(n)} ${denominations[n.denom]}`;
}

function formatValueNoDenom (n) {
	return `${n.units.toString().replace(/(\d)(?=(\d{3})+$)/g, &apos;$1,&apos;)}${n.decimals ? &apos;.&apos; + n.decimals : &apos;&apos;}`;
}

function formatToExponential (v, n) {
	return new BigNumber(v).toExponential(4);
}

function interpretQuantity (s) {
	try {
		let m = s.toLowerCase().match(/([0-9,]+)(\.([0-9]*))? *([a-zA-Z]+)?/);
		let d = denominationMultiplier(m[4] || &apos;ether&apos;);
		let n = +m[1].replace(&apos;,&apos;, &apos;&apos;);
		if (m[2]) {
			n += m[3];
			for (let i = 0; i &lt; m[3].length; ++i) {
				d = d.div(10);
			}
		}
		return new BigNumber(n).mul(d);
	} catch (e) {
		return null;
	}
}

function splitValue (a) {
	var i = 0;
	a = new BigNumber(&apos;&apos; + a);
	if (a.gte(new BigNumber(&apos;10000000000000000&apos;)) &amp;&amp; a.lt(new BigNumber(&apos;100000000000000000000000&apos;))) {
		i = 6;
	} else {
		for (var aa = a; aa.gte(1000) &amp;&amp; i &lt; denominations.length - 1; aa = aa.div(1000)) { i++; }
	}

	for (var j = 0; j &lt; i; ++j) { a = a.div(1000); }

	return {base: a, denom: i};
}

function formatBalance (n) {
	let a = splitValue(n);
	//	let b = Math.floor(a.base * 1000) / 1000;
	return `${a.base} ${denominations[a.denom]}`;
}

function formatBlockNumber (n) {
	return &apos;#&apos; + (&apos;&apos; + n).replace(/(\d)(?=(\d{3})+$)/g, &apos;$1,&apos;);
}

function isNullData (a) {
	return !a || typeof (a) !== &apos;string&apos; || a.match(/^(0x)?0+$/) !== null;
}

function splitSignature (sig) {
	if ((sig.substr(2, 2) === &apos;1b&apos; || sig.substr(2, 2) === &apos;1c&apos;) &amp;&amp; (sig.substr(66, 2) !== &apos;1b&apos; &amp;&amp; sig.substr(66, 2) !== &apos;1c&apos;)) {
		// vrs
		return [sig.substr(0, 4), `0x${sig.substr(4, 64)}`, `0x${sig.substr(68, 64)}`];
	} else {
		// rsv
		return [`0x${sig.substr(130, 2)}`, `0x${sig.substr(2, 64)}`, `0x${sig.substr(66, 64)}`];
	}
}

function removeSigningPrefix (message) {
	if (!message.startsWith(&apos;\x19Ethereum Signed Message:\n&apos;)) {
		throw new Error(&apos;Invalid message - doesn\&apos;t contain security prefix&apos;);
	}
	for (var i = 1; i &lt; 6; ++i) {
		if (message.length === 26 + i + +message.substr(26, i)) {
			return message.substr(26 + i);
		}
	}
	throw new Error(&apos;Invalid message - invalid security prefix&apos;);
}

function cleanup (value, type = &apos;bytes32&apos;, api = parity.api) {
	// TODO: make work with arbitrary depth arrays
	if (value instanceof Array &amp;&amp; type.match(/bytes[0-9]+/)) {
		// figure out if it&apos;s an ASCII string hiding in there:
		var ascii = &apos;&apos;;
		for (var i = 0, ended = false; i &lt; value.length &amp;&amp; ascii !== null; ++i) {
			if (value[i] === 0) {
				ended = true;
			} else {
				ascii += String.fromCharCode(value[i]);
			}
			if ((ended &amp;&amp; value[i] !== 0) || (!ended &amp;&amp; (value[i] &lt; 32 || value[i] &gt;= 128))) {
				ascii = null;
			}
		}
		value = ascii === null ? &apos;0x&apos; + value.map(n =&gt; (&apos;0&apos; + n.toString(16)).slice(-2)).join(&apos;&apos;) : ascii;
	}
	if (type.substr(0, 4) === &apos;uint&apos; &amp;&amp; +type.substr(4) &lt;= 48) {
		value = +value;
	}
	return value;
}

module.exports = {
	asciiToHex,
	bytesToHex,
	hexToAscii,
	isAddressValid,
	toChecksumAddress,
	sha3,
	capitalizeFirstLetter,
	singleton,
	denominations,
	denominationMultiplier,
	interpretRender,
	combineValue,
	defDenom,
	formatValue,
	formatValueNoDenom,
	formatToExponential,
	interpretQuantity,
	splitValue,
	formatBalance,
	formatBlockNumber,
	isNullData,
	splitSignature,
	removeSigningPrefix,
	cleanup
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
