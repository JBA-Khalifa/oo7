<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/oo7-substrate/src/nodeService.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src">oo7-parity/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-parity/src/index.js~Bonds.html">Bonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createBonds">createBonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNotOwned">isNotOwned</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isOwned">isOwned</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bonds">bonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-options">options</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src-abis">oo7-parity/src/abis</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-abiPolyfill">abiPolyfill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BadgeABI">BadgeABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BadgeRegABI">BadgeRegABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GitHubHintABI">GitHubHintABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OperationsABI">OperationsABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RegistryExtras">RegistryExtras</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TokenABI">TokenABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TokenRegABI">TokenRegABI</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src-utils">oo7-parity/src/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-capitalizeFirstLetter">capitalizeFirstLetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanup">cleanup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineValue">combineValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defDenom">defDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-denominationMultiplier">denominationMultiplier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBalance">formatBalance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBlockNumber">formatBlockNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatToExponential">formatToExponential</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValue">formatValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValueNoDenom">formatValueNoDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretQuantity">interpretQuantity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretRender">interpretRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAddressValid">isAddressValid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNullData">isNullData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeSigningPrefix">removeSigningPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha3">sha3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-singleton">singleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitSignature">splitSignature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitValue">splitValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toChecksumAddress">toChecksumAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-asciiToHex">asciiToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bytesToHex">bytesToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-denominations">denominations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hexToAscii">hexToAscii</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-substrate-src">oo7-substrate/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/addressBook.js~AddressBook.html">AddressBook</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/nodeService.js~NodeService.html">NodeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/secretStore.js~SecretStore.html">SecretStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addressBook">addressBook</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nodeService">nodeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setNodeUri">setNodeUri</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pretty">pretty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-secretStore">secretStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-composeTransaction">composeTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post">post</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-src">oo7/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bond.js~Bond.html">Bond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bondCache.js~BondCache.html">BondCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bondProxy.js~BondProxy.html">BondProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/defaultBond.js~DefaultBond.html">DefaultBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/latchBond.js~LatchBond.html">LatchBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/notReadyBond.js~NotReadyBond.html">NotReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/reactiveBond.js~ReactiveBond.html">ReactiveBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/reactivePromise.js~ReactivePromise.html">ReactivePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/readyBond.js~ReadyBond.html">ReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/timeBond.js~TimeBond.html">TimeBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/transformBond.js~TransformBond.html">TransformBond</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#polkadot-identicon-lib">polkadot-identicon/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/polkadot-identicon/lib/index.js~Identicon.html">Identicon</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/oo7-substrate/src/nodeService.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const { Bond } = require(&apos;oo7&apos;)
const WebSocket = require(&apos;isomorphic-ws&apos;)

const subscriptionKey = {
	author_submitAndWatchExtrinsic: {
		notification: &apos;author_extrinsicUpdate&apos;,
		subscribe: &apos;author_submitAndWatchExtrinsic&apos;,
		unsubscribe: &apos;author_unwatchExtrinsic&apos;
	},
	state_storage: {
		notification: &apos;state_storage&apos;,
		subscribe: &apos;state_subscribeStorage&apos;,
		unsubscribe: &apos;state_unsubscribeStorage&apos;
	},
	chain_newHead: {
		notification: &apos;chain_newHead&apos;,
		subscribe: &apos;chain_subscribeNewHead&apos;,
		unsubscribe: &apos;chain_unsubscribeNewHead&apos;
	},
	chain_finalisedHead: {
		notification: &apos;chain_finalisedHead&apos;,
		subscribe: &apos;chain_subscribeFinalisedHeads&apos;,
		unsubscribe: &apos;chain_unsubscribeFinalisedHeads&apos;
	},
	state_runtimeVersion: {
		notification: &apos;state_runtimeVersion&apos;,
		subscribe: &apos;state_subscribeRuntimeVersion&apos;,
		unsubscribe: &apos;state_unsubscribeRuntimeVersion&apos;
	}
}

let uri = [&apos;ws://127.0.0.1:9944&apos;]

function setNodeUri(u) {
	if (uri === u) return
	uri = u
	if (!s_nodeService) return // prevent instanciating
	s_nodeService.uri = u
	s_nodeService.uriIndex = 0
	s_nodeService.uriChanged = true
	s_nodeService.start()
}

class NodeService {
	constructor (uri) {
		this.subscriptions = {}
		this.cancelations = {}
		this.pendingCancelations = {}
		this.theirIds = {}
		this.onReply = {}
		this.onceOpen = []
		this.index = 1
		this.uriIndex = 0
		this.backoff = 0
		this.uri = uri
		this.status = new Bond
		this.start(uri[0])
	}

	start (uri = this.uri[0]) {
		if (this.ws) {
			this.ws.close()
			delete this.ws
		}

		let that = this
		this.ws = new WebSocket(uri)
		this.ws.onopen = function () {
			console.log(&apos;Connection open&apos;)
			that.rejig()
			that.backoff = 0
			let onceOpen = that.onceOpen;
			that.onceOpen = []
			setTimeout(() =&gt; {
//				console.warn(&quot;Proceessing deferred requests...&quot;)
				onceOpen.forEach(f =&gt; f())
			}, 0)
			that.status.trigger({connected: uri})
		}
		this.ws.onmessage = function (msg) {
			if (that.reconnect) {
				clearTimeout(that.reconnect)
			}

			let d = JSON.parse(msg.data)
//			console.log(&apos;Incoming:&apos;, d);
			if (d.id) {
				that.onReply[d.id](d)
				delete that.onReply[d.id];
			} else if (d.method &amp;&amp; d.params &amp;&amp; that.subscriptions[d.params.subscription]) {
				that.subscriptions[d.params.subscription].callback(d.params.result, d.method)
			} else if (that.pendingCancelations[d.params.subscription]) {
				// Ok; this message was sent by them before they heard that we wanted to unsubscribe.
			} else {
				console.warn(&quot;Subscription reply without recognised ID&quot;, d.params.subscription)
			}

			// epect a message every 10 seconds or we reconnect.
			that.reconnect = setTimeout(() =&gt; { console.log(&apos;Reconnecting.&apos;); that.start() }, 60000)
		}
		this.ws.onerror = (err) =&gt; {
			if (that.uriChanged) {
				delete that.uriChanged
				return // no reconnection if uri changed
			}
			setTimeout(() =&gt; {
				that.uriIndex = (that.uriIndex + 1) % that.uri.length
				that.start(that.uri[that.uriIndex])
			}, that.backoff)
			that.backoff = Math.min(30000, that.backoff + 1000)
			that.status.trigger({error: err})
		}
	}

	rejig () {
		let that = this
		let subs = this.subscriptions
		this.subscriptions = {}
		let theirIds = this.theirIds
		this.theirIds = {}
		Object.keys(theirIds).forEach(ourId =&gt; {
			let sub = subs[theirIds[ourId]]
			that.subscribe(sub.what, sub.params, sub.callback, console.warn, ourId)
		})
	}

	req (method, params, callback) {
		let that = this
		let doSend = () =&gt; {
			let id = &apos;&apos; + this.index++;
//			console.warn(&quot;Executing request&quot;, method, params, id, callback)
			let msg = {
				&quot;jsonrpc&quot;: &quot;2.0&quot;,
				&quot;id&quot;: id,
				&quot;method&quot;: method,
				&quot;params&quot;: params
			};
			that.ws.send(JSON.stringify(msg))
	
			that.onReply[id] = callback
		}

		if (this.ws.readyState === 1) {
			doSend(callback)
		} else {
//			console.warn(&quot;Defering request until connected&quot;, method, params)
			that.onceOpen.push(() =&gt; {
				doSend(callback)
			})
		}
	}

	request (method, params = []) {
		let that = this
		return new Promise((resolve, reject) =&gt; {
			that.req(method, params, msg =&gt; {
//				console.warn(&quot;Processing request reply&quot;, method, params, msg)
				if (msg.error) {
					reject(msg.error)
				} else {
					resolve(msg.result)
				}
			})
		})
	}

	subscribe (what, params, callback, errorHandler, ourId = null) {
		let that = this
		return new Promise((resolve, reject) =&gt; {
//			console.log(&apos;Subscribing&apos;, ourId)
			this.req(subscriptionKey[what].subscribe, params, msg =&gt; {
				if (msg.error) {
//					console.log(&apos;Error subscribing&apos;, ourId)
					errorHandler(msg.error)
				} else {
					let theirId = msg.result
//					console.log(&apos;Subscribed&apos;, &apos;ourId=&apos;, ourId, &apos;theirId=&apos;, theirId)
					if (that.cancelations[ourId]) {
//						console.log(&apos;Delayed unsubscription of&apos;, ourId)
						that.pendingCancelations[theirId] = ourId
						this.req(subscriptionKey[what].unsubscribe, [theirId], () =&gt; {
							delete that.pendingCancelations[theirId]
							delete that.cancelations[ourId]
						}, errorHandler)
					} else {
						that.subscriptions[theirId] = { what, params, callback }
						ourId = ourId || theirId
						that.theirIds[ourId] = theirId
					}
					// We resolve to our ID regardless which should be safe since
					// unsubscribes of old IDs are no-ops.
					resolve(ourId)
				}
			})
		})
	}

	unsubscribe (ourId) {
		let that = this

		if (this.theirIds[ourId] == null) {
//			console.log(&apos;Resubscription not yet complete. Defering unsubscribe&apos;, ourId)
			this.cancelations[ourId] = true
			return
		}
		let theirId = this.theirIds[ourId]
		if (!this.subscriptions[theirId]) {
			throw &apos;Invalid subscription id&apos;
		}
		let unsubscribe = subscriptionKey[this.subscriptions[theirId].what].unsubscribe

//		console.log(&apos;Unsubscribing&apos;, ourId, theirId, this.subscriptions[theirId].what, unsubscribe)
		this.req(unsubscribe, [theirId], () =&gt; {
			delete that.theirIds[ourId]
			delete that.subscriptions[theirId]
		})
	}
	
	finalise () {
		delete this.ws;
	}
}

let s_nodeService = null;

function nodeService() {
	if (!s_nodeService) {
		s_nodeService = new NodeService(uri);
	}
	return s_nodeService;
}

module.exports = { nodeService, NodeService, setNodeUri };
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
