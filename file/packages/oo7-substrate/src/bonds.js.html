<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/oo7-substrate/src/bonds.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src">oo7-parity/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-parity/src/index.js~Bonds.html">Bonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createBonds">createBonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNotOwned">isNotOwned</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isOwned">isOwned</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bonds">bonds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-options">options</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src-abis">oo7-parity/src/abis</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-abiPolyfill">abiPolyfill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BadgeABI">BadgeABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BadgeRegABI">BadgeRegABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GitHubHintABI">GitHubHintABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OperationsABI">OperationsABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RegistryExtras">RegistryExtras</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TokenABI">TokenABI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TokenRegABI">TokenRegABI</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-parity-src-utils">oo7-parity/src/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-capitalizeFirstLetter">capitalizeFirstLetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanup">cleanup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineValue">combineValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defDenom">defDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-denominationMultiplier">denominationMultiplier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBalance">formatBalance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatBlockNumber">formatBlockNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatToExponential">formatToExponential</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValue">formatValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatValueNoDenom">formatValueNoDenom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretQuantity">interpretQuantity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-interpretRender">interpretRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAddressValid">isAddressValid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNullData">isNullData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeSigningPrefix">removeSigningPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha3">sha3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-singleton">singleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitSignature">splitSignature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-splitValue">splitValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toChecksumAddress">toChecksumAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-asciiToHex">asciiToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bytesToHex">bytesToHex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-denominations">denominations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hexToAscii">hexToAscii</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-substrate-src">oo7-substrate/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/addressBook.js~AddressBook.html">AddressBook</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/nodeService.js~NodeService.html">NodeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7-substrate/src/secretStore.js~SecretStore.html">SecretStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addressBook">addressBook</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nodeService">nodeService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setNodeUri">setNodeUri</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pretty">pretty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-secretStore">secretStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-composeTransaction">composeTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post">post</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oo7-src">oo7/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bond.js~Bond.html">Bond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bondCache.js~BondCache.html">BondCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/bondProxy.js~BondProxy.html">BondProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/defaultBond.js~DefaultBond.html">DefaultBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/latchBond.js~LatchBond.html">LatchBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/notReadyBond.js~NotReadyBond.html">NotReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/reactiveBond.js~ReactiveBond.html">ReactiveBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/reactivePromise.js~ReactivePromise.html">ReactivePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/readyBond.js~ReadyBond.html">ReadyBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/timeBond.js~TimeBond.html">TimeBond</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/oo7/src/transformBond.js~TransformBond.html">TransformBond</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#polkadot-identicon-lib">polkadot-identicon/lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/polkadot-identicon/lib/index.js~Identicon.html">Identicon</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/oo7-substrate/src/bonds.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const { camel } = require(&apos;change-case&apos;);
const { Bond, TransformBond, TimeBond } = require(&apos;oo7&apos;)
const { nodeService } = require(&apos;./nodeService&apos;)
const { SubscriptionBond } = require(&apos;./subscriptionBond&apos;)
const { BlockNumber, Hash } = require(&apos;./types&apos;);
const { decode, encode } = require(&apos;./codec&apos;);
const { stringToBytes, hexToBytes, bytesToHex, toLE } = require(&apos;./utils&apos;)
const { StorageBond } = require(&apos;./storageBond&apos;)
const { setMetadata } = require(&apos;./metadata&apos;)

let chain = (() =&gt; {
	let head = new SubscriptionBond(&apos;chain_newHead&apos;).subscriptable()
	let finalisedHead = new SubscriptionBond(&apos;chain_finalisedHead&apos;).subscriptable()
	let height = head.map(h =&gt; new BlockNumber(h.number))
	let finalisedHeight = finalisedHead.map(h =&gt; new BlockNumber(h.number))
	let lag = Bond.all([height, finalisedHeight]).map(([h, f]) =&gt; new BlockNumber(h - f))
	let header = hashBond =&gt; new TransformBond(hash =&gt; nodeService().request(&apos;chain_getHeader&apos;, [hash]), [hashBond]).subscriptable()
	let block = hashBond =&gt; new TransformBond(hash =&gt; nodeService().request(&apos;chain_getBlock&apos;, [hash]), [hashBond]).subscriptable()
	let hash = numberBond =&gt; new TransformBond(number =&gt; nodeService().request(&apos;chain_getBlockHash&apos;, [number]), [numberBond])
	return { head, finalisedHead, height, finalisedHeight, header, hash, block, lag }
})()

let system = (() =&gt; {
	let time = new TimeBond
	let name = new TransformBond(() =&gt; nodeService().request(&apos;system_name&apos;)).subscriptable()
	let version = new TransformBond(() =&gt; nodeService().request(&apos;system_version&apos;)).subscriptable()
	let chain = new TransformBond(() =&gt; nodeService().request(&apos;system_chain&apos;)).subscriptable()
	let properties = new TransformBond(() =&gt; nodeService().request(&apos;system_properties&apos;)).subscriptable()
	let health = new TransformBond(() =&gt; nodeService().request(&apos;system_health&apos;), [], [time]).subscriptable()
	let peers = new TransformBond(() =&gt; nodeService().request(&apos;system_peers&apos;), [], [time]).subscriptable()
	let pendingTransactions = new TransformBond(() =&gt; nodeService().request(&apos;author_pendingExtrinsics&apos;)).subscriptable()
	return { name, version, chain, properties, pendingTransactions, health, peers }
})()

let version = (new SubscriptionBond(&apos;state_runtimeVersion&apos;, [], r =&gt; {
	let apis = {}
	r.apis.forEach(([id, version]) =&gt; {
		if (typeof id !== &apos;string&apos;) {
			id = String.fromCharCode.apply(null, id)
		}
		apis[id] = version
	})
	return {
		authoringVersion: r.authoringVersion,
		implName: r.implName,
		implVersion: r.implVersion,
		specName: r.specName,
		specVersion: r.specVersion,
		apis
	}
})).subscriptable()

let runtime = {
	version, 
	metadata: new Bond,
	core: (() =&gt; {
		let authorityCount = new SubscriptionBond(&apos;state_storage&apos;, [[&apos;0x&apos; + bytesToHex(stringToBytes(&apos;:auth:len&apos;))]], r =&gt; decode(hexToBytes(r.changes[0][1]), &apos;u32&apos;))
		let authorities = authorityCount.map(
			n =&gt; [...Array(n)].map((_, i) =&gt;
				new SubscriptionBond(&apos;state_storage&apos;,
					[[ &apos;0x&apos; + bytesToHex(stringToBytes(&quot;:auth:&quot;)) + bytesToHex(toLE(i, 4)) ]],
					r =&gt; decode(hexToBytes(r.changes[0][1]), &apos;AccountId&apos;)
				)
			), 2)
		let code = new SubscriptionBond(&apos;state_storage&apos;, [[&apos;0x&apos; + bytesToHex(stringToBytes(&apos;:code&apos;))]], r =&gt; hexToBytes(r.changes[0][1]))
		let codeHash = new TransformBond(() =&gt; nodeService().request(&apos;state_getStorageHash&apos;, [&apos;0x&apos; + bytesToHex(stringToBytes(&quot;:code&quot;))]).then(hexToBytes), [], [version])
		let codeSize = new TransformBond(() =&gt; nodeService().request(&apos;state_getStorageSize&apos;, [&apos;0x&apos; + bytesToHex(stringToBytes(&quot;:code&quot;))]), [], [version])
		let heapPages = new SubscriptionBond(&apos;state_storage&apos;, [[&apos;0x&apos; + bytesToHex(stringToBytes(&apos;:heappages&apos;))]], r =&gt; decode(hexToBytes(r.changes[0][1]), &apos;u64&apos;))
		return { authorityCount, authorities, code, codeHash, codeSize, version, heapPages }
	})()
}

let calls = {}

class RuntimeUp extends Bond {
	initialise() {
		let that = this
		initRuntime(() =&gt; that.trigger(true))
	}
}
let runtimeUp = new RuntimeUp

let onRuntimeInit = []

function initialiseFromMetadata (md) {
	console.log(&quot;initialiseFromMetadata&quot;, md)
	setMetadata(md)
	let callIndex = 0;
	md.modules.forEach((m) =&gt; {
		let o = {}
		let c = {}
		if (m.storage) {
			let storePrefix = m.prefix
			m.storage.forEach(item =&gt; {
				switch (item.type.option) {
					case &apos;Plain&apos;: {
						o[camel(item.name)] = new StorageBond(`${storePrefix} ${item.name}`, item.type.value, [], item.default)
						break
					}
					case &apos;Map&apos;: {
						let keyType = item.type.value.key
						let valueType = item.type.value.value
						o[camel(item.name)] = keyBond =&gt; new TransformBond(
							key =&gt; new StorageBond(`${storePrefix} ${item.name}`, valueType, encode(key, keyType), item.default),
							[keyBond]
						).subscriptable()
						break
					}
				}
			})
		}
		if (m.calls) {
			let thisCallIndex = callIndex
			callIndex++
			m.calls.forEach((item, id) =&gt; {
				if (item.arguments.length &gt; 0 &amp;&amp; item.arguments[0].name == &apos;origin&apos; &amp;&amp; item.arguments[0].type == &apos;Origin&apos;) {
					item.arguments = item.arguments.slice(1)
				}
				c[camel(item.name)] = function (...bondArgs) {
					if (bondArgs.length != item.arguments.length) {
						throw `Invalid number of argments (${bondArgs.length} given, ${item.arguments.length} expected)`
					}
					return new TransformBond(args =&gt; {
						let encoded_args = encode(args, item.arguments.map(x =&gt; x.type))
						let res = new Uint8Array([thisCallIndex, id, ...encoded_args]);
						console.log(`Encoding call ${m.name}.${item.name} (${thisCallIndex}.${id}): ${bytesToHex(res)}`)
						return res
					}, [bondArgs], [], 3, 3, undefined, true)
				}
				c[camel(item.name)].help = item.arguments.map(a =&gt; a.name)
			})				
		}
		runtime[camel(m.name)] = o
		calls[camel(m.name)] = c
	})
	md.modules.forEach(m =&gt; {
		if (m.storage) {
			try {
				require(`./srml/${m.name}`).augment(runtime, chain)
			}
			catch (e) {
				if (!e.toString().startsWith(&apos;Error: Cannot find module&apos;)) {
					throw e
				}
			}
		}
	})
	if (onRuntimeInit !== null) {
		onRuntimeInit.forEach(f =&gt; { if (f) f() })
		onRuntimeInit = null
	}

	runtime.metadata.trigger(md)
}

function decodeMetadata(bytes) {
	let input = { data: bytes }
	let head = decode(input, &apos;MetadataHead&apos;)
	if (head.magic === 0x6174656d) {
		if (head.version == 1) {
			return decode(input, &apos;MetadataBody&apos;)
		} else {
			throw `Metadata version ${head.version} not supported`
		}
	} else {
		let md = decode(bytes, &apos;Legacy_RuntimeMetadata&apos;)
		md.modules = md.modules.map(m =&gt; {
			m.name = m.prefix
			m.prefix = m.storage ? m.storage.prefix : null
			m.storage = m.storage ? m.storage.items : null
			m.calls = m.module &amp;&amp; m.module.call ? m.module.call.functions : null
			return m
		})
		return md
	}
}

function initRuntime (callback = null) {
	if (onRuntimeInit instanceof Array) {
		onRuntimeInit.push(callback)
		version.tie(() =&gt; {
//			console.info(&quot;Initialising runtime&quot;)
			nodeService().request(&apos;state_getMetadata&apos;)
				.then(blob =&gt; decodeMetadata(hexToBytes(blob)))
				.then(initialiseFromMetadata)
		})
	} else {
		// already inited runtime
		if (callback) {
			callback()
		}
	}
}

function runtimePromise() {
	return new Promise((resolve, reject) =&gt; initRuntime(() =&gt; resolve(runtime)))
}

function callsPromise() {
	return new Promise((resolve, reject) =&gt; initRuntime(() =&gt; resolve(calls)))
}

module.exports = { initRuntime, runtimeUp, runtimePromise, callsPromise, runtime, calls, chain, system }
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
